##
##  Rulebook - Policy Rule Rendering Application
##  Copyright (c) 2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
##  Licensed under GPL 3.0 <https://spdx.org/licenses/GPL-3.0-only>
##

#   [rulebook-4-cli] (internal): create patch set for NPM dependencies
patch-make
    npm shrinkwrap && \
    patch-package --patch-dir package.d "ws" && \
    shx rm -f npm-shrinkwrap.json

#   [rulebook-4-cli] (internal): apply patch set for NPM dependencies
patch-apply
    patch-package --patch-dir package.d

#   [rulebook-3-cli] static code analysis (continuous file watching)
lint-watch
    nodemon --exec "npm start lint" --watch src --ext ts

#   [rulebook-4-cli] static code analysis
lint
    check-dependencies && \
    eslint --config etc/eslint.mjs src/**/*.ts && \
    markdownlint-cli2 --config etc/.markdownlint.yaml src/**/*.md

#   [rulebook-4-cli] build components for production (continuous file watching)
build-watch
    nodemon --exec "npm start build" --watch src --ext ts,1

#   [rulebook-4-cli] build components for production
build : lint build:cmd build:man

#   [rulebook-4-cli] build command for production
build:cmd
    vite --config etc/vite.mts build --mode production

#   [rulebook-4-cli] build manual page for production
build:man
    shx mkdir -p dst-stage3 && \
    remark --quiet --use remark-man --output dst-stage3/rulebook.1 src/rulebook.md

#   [rulebook-4-cli] build all-in-one packages
package [hostname=en4.*]
    cd dst-stage2 && \
    shx rm -f rulebook-4-cli-* && \
    targets="node24-linux-x64,node24-linux-arm64"
    targets="$targets,node24-win-x64,node24-win-arm64"
    targets="$targets,node24-macos-x64,node24-macos-arm64"
    pkg --sea --public -c ../package.json -t "$targets" rulebook.js && \
    shx mkdir -p ../dst-stage3 && \
    shx mv rulebook-4-cli-linux-x64     ../dst-stage3/rulebook-lnx-x64     && \
    shx mv rulebook-4-cli-linux-arm64   ../dst-stage3/rulebook-lnx-a64     && \
    shx mv rulebook-4-cli-win-x64.exe   ../dst-stage3/rulebook-win-x64.exe && \
    shx mv rulebook-4-cli-win-arm64.exe ../dst-stage3/rulebook-win-a64.exe && \
    shx mv rulebook-4-cli-macos-x64     ../dst-stage3/rulebook-mac-x64     && \
    shx mv rulebook-4-cli-macos-arm64   ../dst-stage3/rulebook-mac-a64

#   [rulebook-4-cli] development mode
dev
    chokidar "../rulebook-2-rnd/src/*" "../rulebook-3-lib/src/*" "src/*" "../rulebook-7-smp/src/*.yaml" -c "npm start dev:exec"
dev:exec
    (cd .. && npm start build) && \
    node dst-stage2/rulebook.js -v \
        make -f card -o ../rulebook-7-smp/output-card.html ../rulebook-7-smp/src/ && \
    node dst-stage2/rulebook.js -v \
        make -f prose -o ../rulebook-7-smp/output-prose.html ../rulebook-7-smp/src/

#   [rulebook-4-cli] remove all generated artifacts (reverse of "npm start build")
clean
    shx rm -rf dst-stage1 dst-stage2 dst-stage3

#   [rulebook-4-cli] remove all generated artifacts (reverse of "npm install" and "npm start build")
clean:dist : clean
    shx rm -f package-lock.json && \
    shx rm -rf node_modules

