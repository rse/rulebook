##
##  Rulebook - Policy Rule Rendering Application
##  Copyright (c) 2025 Dr. Ralf S. Engelschall <rse@engelschall.com>
##  Licensed under GPL 3.0 <https://spdx.org/licenses/GPL-3.0-only>
##

#   package distribution archives
package
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' ../package.json` && \
    echo "++ building distribution archives for Rulebook $VERSION ++" && \
    rm -rf dst-stage1 dst-stage2 && \
    mkdir -p dst-stage1/rulebook-$VERSION/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-win-x64/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-win-a64/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-mac-x64/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-mac-a64/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-lnx-x64/ && \
    mkdir -p dst-stage1/rulebook-$VERSION-lnx-a64/ && \
    mkdir -p dst-stage2 && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-win-x64/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-win-a64/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-mac-x64/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-mac-a64/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-lnx-x64/rulebook-app.zip && \
    cp -p ../rulebook-2-app/dst-stage2/rulebook.zip                dst-stage1/rulebook-$VERSION-lnx-a64/rulebook-app.zip && \
    cp -p ../rulebook-3-cli/dst-stage2/rulebook.js                 dst-stage1/rulebook-$VERSION/rulebook-cli.js && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-win-x64.exe    dst-stage1/rulebook-$VERSION-win-x64/rulebook-cli.exe && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-win-a64.exe    dst-stage1/rulebook-$VERSION-win-a64/rulebook-cli.exe && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-mac-x64        dst-stage1/rulebook-$VERSION-mac-x64/rulebook-cli && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-mac-a64        dst-stage1/rulebook-$VERSION-mac-a64/rulebook-cli && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-lnx-x64        dst-stage1/rulebook-$VERSION-lnx-x64/rulebook-cli && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook-cli-lnx-a64        dst-stage1/rulebook-$VERSION-lnx-a64/rulebook-cli && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-win-x64/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-win-a64/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-mac-x64/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-mac-a64/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-lnx-x64/rulebook-cli.man && \
    cp -p ../rulebook-3-cli/dst-stage3/rulebook.1                  dst-stage1/rulebook-$VERSION-lnx-a64/rulebook-cli.man && \
    cd dst-stage1 && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION.zip         rulebook-$VERSION/         && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-win-x64.zip rulebook-$VERSION-win-x64/ && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-win-a64.zip rulebook-$VERSION-win-a64/ && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-mac-x64.zip rulebook-$VERSION-mac-x64/ && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-mac-a64.zip rulebook-$VERSION-mac-a64/ && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-lnx-x64.zip rulebook-$VERSION-lnx-x64/ && \
    zip -9 -r ../dst-stage2/rulebook-$VERSION-lnx-a64.zip rulebook-$VERSION-lnx-a64/

#   publish distribution archives
publish
    VERSION=`sed -n '/"version":/ s/.*: *"\(.*\)".*/\1/p' ../package.json` && \
    V=`echo "$VERSION" | sed -e 's;\.;\\.;g'` && \
    sed -n -e "/^${V} /, /^[0-9]\\./ { /^${V} /p; /^[0-9]\\./!p; }" <../CHANGELOG.md >.notes.md && \
    gh release create --title "Rulebook $VERSION" --notes-file .notes.md --verify-tag $VERSION \
    dst-stage2/rulebook-$VERSION.zip \
    dst-stage2/rulebook-$VERSION-win-x64.zip \
    dst-stage2/rulebook-$VERSION-win-a64.zip \
    dst-stage2/rulebook-$VERSION-mac-x64.zip \
    dst-stage2/rulebook-$VERSION-mac-a64.zip \
    dst-stage2/rulebook-$VERSION-lnx-x64.zip \
    dst-stage2/rulebook-$VERSION-lnx-a64.zip && \
    rm -f .notes.md

#   remove all generated artifacts (reverse of "npm start build")
clean
    shx rm -rf dst-stage1 dst-stage2

#   remove all generated artifacts (reverse of "npm install" and "npm start build")
clean:dist : clean
    shx rm -f package-lock.json && \
    shx rm -rf node_modules

